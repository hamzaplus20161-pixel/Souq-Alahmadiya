<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Iron Man Hand Tracking Mobile</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  overflow: hidden;
  background: black;
  font-family: Arial;
}

/* HUD */
#hud {
  position: fixed;
  top: 15px;
  left: 15px;
  color: cyan;
  font-size: 16px;
  text-shadow: 0 0 10px cyan;
  z-index: 30;
}

/* CAMERA */
video {
  position: fixed;
  inset: 0;
  width: 100vw;
  height: 100vh;
  object-fit: cover;
  z-index: 0;
}

/* HAND HUD */
#overlay {
  position: fixed;
  inset: 0;
  z-index: 10;
  pointer-events: none;
}

/* THREE */
#three {
  position: fixed;
  inset: 0;
  z-index: 20;
  pointer-events: none;
}
</style>
</head>

<body>

<div id="hud">
IRON MODE – MOBILE<br>
✋ Hand Tracking Active
</div>

<video id="video" autoplay playsinline muted></video>
<canvas id="overlay"></canvas>

<script src="https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<script>
// ================= CANVAS =================
const canvas = document.getElementById("overlay");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();

// ================= THREE =================
const scene = new THREE.Scene();

const cam3D = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
cam3D.position.z = 6;

const renderer = new THREE.WebGLRenderer({ alpha:true, antialias:true });
renderer.setSize(innerWidth, innerHeight);
renderer.domElement.id = "three";
document.body.appendChild(renderer.domElement);

const light = new THREE.PointLight(0x00ffff, 2, 100);
light.position.set(0,5,10);
scene.add(light);

// Cursor
const cursor = new THREE.Mesh(
  new THREE.BoxGeometry(0.6,0.6,0.6),
  new THREE.MeshStandardMaterial({
    color:0x00ffff,
    emissive:0x00ffff,
    emissiveIntensity:0.8
  })
);
scene.add(cursor);

// Voxels
const voxels = new THREE.Group();
scene.add(voxels);

function animate(){
  requestAnimationFrame(animate);
  renderer.render(scene, cam3D);
}
animate();

// ================= CAMERA (MANUAL) =================
const video = document.getElementById("video");

navigator.mediaDevices.getUserMedia({
  video: { facingMode: "user" },
  audio: false
}).then(stream=>{
  video.srcObject = stream;
  video.play();
}).catch(e=>{
  alert("Camera Error: " + e.message);
});

// ================= MEDIAPIPE =================
const hands = new Hands({
  locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});

hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.7,
  minTrackingConfidence:0.7
});

let lastAdd = 0;

hands.onResults(res=>{
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(!res.multiHandLandmarks) return;

  const lm = res.multiHandLandmarks[0];
  const index = lm[8];
  const thumb = lm[4];
  const palm = lm[0];

  // Draw points
  lm.forEach(p=>{
    ctx.beginPath();
    ctx.arc(p.x*canvas.width,p.y*canvas.height,5,0,Math.PI*2);
    ctx.fillStyle="cyan";
    ctx.fill();
  });

  // Palm HUD
  ctx.beginPath();
  ctx.arc(palm.x*canvas.width,palm.y*canvas.height,80,0,Math.PI*2);
  ctx.strokeStyle="cyan";
  ctx.lineWidth=2;
  ctx.stroke();

  // Move cursor
  cursor.position.x = (index.x-0.5)*6;
  cursor.position.y = -(index.y-0.5)*4;
  cursor.position.z = -index.z*5;

  // Pinch
  const d = Math.hypot(index.x-thumb.x,index.y-thumb.y);
  if(d<0.04 && Date.now()-lastAdd>500){
    const cube = cursor.clone();
    cube.position.copy(cursor.position);
    voxels.add(cube);
    lastAdd = Date.now();
  }
});

// LOOP
async function loop(){
  await hands.send({image:video});
  requestAnimationFrame(loop);
}
video.onloadeddata = loop;

// Resize
addEventListener("resize",()=>{
  resize();
  cam3D.aspect = innerWidth/innerHeight;
  cam3D.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});
</script>

</body>
</html>
